# üèÜ Nuevo Sistema de Selecci√≥n Autom√°tica de Estrategias

## üéØ ¬øQu√© es?

Un sistema inteligente que:
1. ‚úÖ **Ejecuta backtests autom√°ticos** en todas tus estrategias cada d√≠a
2. ‚úÖ **Rankea las estrategias** por Sharpe, Win Rate y Drawdown
3. ‚úÖ **Selecciona la mejor** autom√°ticamente
4. ‚úÖ **Genera un plan de trade** concreto con precio, cantidad y niveles
5. ‚úÖ **Compara real vs simulado** para detectar divergencias

---

## üöÄ C√≥mo Usarlo

### Opci√≥n 1: Interfaz Visual (Recomendado)

```powershell
.\EJECUTAR_ENHANCED_UI.bat
```

O desde PowerShell:
```powershell
python -m streamlit run ui/app_enhanced.py
```

### Opci√≥n 2: Script de Consola

```powershell
python examples/example_auto_strategy_selection.py
```

---

## üìä Componentes Nuevos

### 1. Strategy Orchestrator
**Archivo**: `app/service/strategy_orchestrator.py`

**Funcionalidad**:
- Registra todas las estrategias disponibles
- Ejecuta backtests con capital base de $1,000
- Calcula m√©tricas completas para cada estrategia
- Rankea por score compuesto (Sharpe 30%, WR 25%, DD 20%, PF 15%, Exp 10%)

**Uso**:
```python
from app.service.strategy_orchestrator import StrategyOrchestrator

orchestrator = StrategyOrchestrator(capital=1000, max_risk_pct=0.02)
results = orchestrator.run_all_backtests("BTC-USDT", "1h")
ranked = orchestrator.rank_strategies(results)
best_strategy, score = ranked[0]
```

### 2. Strategy Ranking Service
**Archivo**: `app/service/strategy_ranking.py`

**Funcionalidad**:
- Obtiene la mejor estrategia del d√≠a
- Genera plan de trade concreto (entrada, SL, TP, cantidad)
- Calcula nivel de confianza (HIGH/MEDIUM/LOW)
- Compara todas las estrategias en DataFrame

**Uso**:
```python
from app.service.strategy_ranking import StrategyRankingService

service = StrategyRankingService(capital=1000)
recommendation = service.get_daily_recommendation("BTC-USDT", "1h", capital=1000)

print(f"Mejor estrategia: {recommendation.best_strategy_name}")
print(f"Direcci√≥n: {recommendation.signal_direction}")
print(f"Entrada: ${recommendation.entry_price}")
```

### 3. Truth Sync Service
**Archivo**: `app/service/truth_sync.py`

**Funcionalidad**:
- Sincroniza trades ejecutados con predicciones del backtest
- Calcula divergencia entre real y simulado
- Genera alertas autom√°ticas cuando divergencia > 20%
- Crea reportes diarios de comparaci√≥n

**Uso**:
```python
from app.service.truth_sync import TruthSyncService

sync = TruthSyncService()
result = sync.sync_daily_performance()  # Sincroniza ayer
report = sync.generate_daily_report(days=7)
print(report)
```

### 4. Risk Profiles
**Archivo**: `app/config/settings.py`

**Perfiles Disponibles**:
- üå± **Starter $1K**: Capital $500-$2K, Risk 1.5%, Min $10/trade
- üìà **Intermediate $5K**: Capital $3K-$10K, Risk 2%, Min $50/trade
- üíé **Advanced $25K**: Capital $15K-$100K, Risk 2-4%, Min $200/trade
- üèÜ **Professional $100K+**: Capital $75K+, Risk 2-5%, Min $500/trade

**Uso**:
```python
from app.config.settings import get_risk_profile_for_capital

profile = get_risk_profile_for_capital(1000)  # Auto-selecciona Starter
print(profile.display_name)
print(f"Risk: {profile.default_risk_pct:.1%}")
```

---

## üåê Nuevos Endpoints de API

### GET /strategy/best
Obtiene la mejor estrategia del d√≠a

**Request**:
```
GET /strategy/best?symbol=BTC-USDT&timeframe=1h&capital=1000
```

**Response**:
```json
{
  "best_strategy_name": "MA Crossover",
  "composite_score": 85.3,
  "sharpe_ratio": 1.8,
  "win_rate": 0.62,
  "signal_direction": 1,
  "entry_price": 95234.50,
  "stop_loss": 94100.00,
  "take_profit": 97500.00,
  "quantity": 0.010526,
  "confidence_level": "HIGH"
}
```

### GET /strategy/compare
Compara todas las estrategias

**Response**:
```json
{
  "strategies": [
    {
      "Strategy": "MA Crossover",
      "Sharpe": 1.8,
      "Win Rate": 0.62,
      ...
    }
  ],
  "count": 3
}
```

### GET /trades/history
Historial de trades con filtros

**Request**:
```
GET /trades/history?symbol=BTC-USDT&start_date=2025-10-01&limit=50
```

### GET /trades/stats
Estad√≠sticas agregadas

**Request**:
```
GET /trades/stats?days=30
```

**Response**:
```json
{
  "stats": {
    "total_trades": 45,
    "win_rate": 0.58,
    "total_pnl": 234.50,
    "profit_factor": 1.85
  }
}
```

### GET /alerts/divergence
Alertas de divergencia real vs simulado

**Response**:
```json
{
  "alerts": [
    {
      "date": "2025-10-18",
      "strategy_name": "RSI Regime",
      "alert_reason": "PnL divergence: 25.3%"
    }
  ]
}
```

### GET /profiles
Lista de perfiles de riesgo

### GET /profiles/recommend
Perfil recomendado para un capital

---

## üì± Interfaz Mejorada (app_enhanced.py)

### Tab 1: üèÜ Auto Strategy
- Muestra la mejor estrategia del d√≠a
- Score compuesto y m√©tricas clave
- Nivel de confianza (HIGH/MEDIUM/LOW)
- Plan de trade completo con precio, cantidad, SL y TP

### Tab 2: üìä Strategy Comparison
- Tabla comparativa de todas las estrategias
- Gr√°ficos de Sharpe y Win Rate
- Identifica la mejor por cada m√©trica
- Descarga CSV de la comparaci√≥n

### Tab 3: üìú Trade History
- Historial completo de trades ejecutados
- Filtros por estado y lado
- Estad√≠sticas agregadas (Win Rate, PnL Total, etc.)
- Gr√°fico de P&L acumulado
- Descarga CSV del historial

---

## üíº Perfiles de Riesgo en UI

En el sidebar ahora puedes:
1. Seleccionar perfil manualmente o autom√°tico
2. El perfil se ajusta seg√∫n tu capital
3. Ver detalles del perfil seleccionado
4. Los par√°metros (risk%, comisiones, ATR multipliers) se aplican autom√°ticamente

---

## üîÑ Workflow Diario Completo

### Ma√±ana (09:00 AM):

1. **Abrir app_enhanced.py**
   ```
   .\EJECUTAR_ENHANCED_UI.bat
   ```

2. **Ir al Tab "üèÜ Auto Strategy"**
   - Ver cu√°l estrategia es la mejor hoy
   - Revisar el score y confianza
   - Si confianza es HIGH (üü¢), continuar

3. **Revisar Plan de Trade**
   - Direcci√≥n: LONG o SHORT
   - Precio de entrada
   - Stop Loss y Take Profit
   - Cantidad exacta en units

4. **Ir al Tab "üìä Strategy Comparison"** (Opcional)
   - Ver c√≥mo se comparan todas las estrategias
   - Validar que la selecci√≥n tiene sentido

5. **Ejecutar en Binance**
   - Seguir la gu√≠a paso a paso en onboarding
   - Colocar orden LIMIT
   - Configurar SL y TP
   - Monitorear

### Tarde/Noche:

6. **Monitorear Posici√≥n**
   - Revisar evoluci√≥n del precio
   - Verificar que SL/TP siguen activos

7. **Fin del D√≠a**
   - Si el trade cerr√≥, registrar resultado
   - Ir al Tab "üìú Trade History"
   - Ver el trade en la tabla
   - Revisar P&L acumulado

### Semanal/Mensual:

8. **An√°lisis de Divergencia**
   - Ejecutar script de sincronizaci√≥n
   - Revisar alertas de divergencia
   - Ajustar estrategias si es necesario

---

## üß™ Testing

### Test 1: Ejecutar Ejemplo
```powershell
python examples/example_auto_strategy_selection.py
```

**Resultado esperado**:
- Lista todas las estrategias
- Muestra la mejor con score
- Genera plan de trade
- Muestra tabla comparativa

### Test 2: UI Enhanced
```powershell
python -m streamlit run ui/app_enhanced.py
```

**Verificar**:
- Tab Auto Strategy muestra recomendaci√≥n
- Tab Strategy Comparison muestra tabla y gr√°ficos
- Tab Trade History muestra trades (si hay)
- Selector de perfil de riesgo funciona

### Test 3: API Endpoints
```powershell
# Iniciar API
python main.py

# En otra terminal, test endpoints:
curl http://localhost:8000/strategy/best?symbol=BTC-USDT&timeframe=1h&capital=1000
curl http://localhost:8000/strategy/compare?symbol=BTC-USDT&timeframe=1h
curl http://localhost:8000/trades/history
curl http://localhost:8000/profiles
```

---

## ‚ö†Ô∏è Consideraciones Importantes

### Capital Peque√±o ($1K)
- ‚úÖ Usar perfil "Starter $1K"
- ‚úÖ Risk 1.5% m√°ximo ($15/trade)
- ‚úÖ Verificar que posici√≥n m√≠nima de Binance se cumple (t√≠picamente $10)
- ‚ö†Ô∏è Comisiones son significativas (0.1% cada entrada/salida = 0.2% total)
- ‚ö†Ô∏è Slippage puede afectar m√°s en % con capital peque√±o

### Ejecuci√≥n en Binance
- ‚úÖ Siempre usar √≥rdenes LIMIT (no MARKET)
- ‚úÖ Configurar SL y TP SIEMPRE
- ‚úÖ Verificar saldo disponible antes
- ‚ö†Ô∏è Horarios: Mercado crypto es 24/7, pero nuestras ventanas son espec√≠ficas
- ‚ö†Ô∏è Volatilidad: BTC puede moverse r√°pido, estar atento

### Divergencia Real vs Simulado
- Es normal que haya divergencia de 5-10%
- Factores: slippage real, timing de ejecuci√≥n, condiciones de mercado
- Alertas solo se disparan con divergencia > 20%
- Revisar semanalmente para ajustar si es necesario

---

## üìö Archivos Creados

1. `app/service/strategy_orchestrator.py` - Orquestador de backtests
2. `app/service/strategy_ranking.py` - Servicio de ranking y recomendaci√≥n
3. `app/service/truth_sync.py` - Sincronizaci√≥n real vs simulado
4. `ui/app_enhanced.py` - UI mejorada con auto-selecci√≥n
5. `ui/onboarding.py` - Gu√≠a de ejecuci√≥n en Binance
6. `examples/example_auto_strategy_selection.py` - Ejemplo de uso
7. `app/config/settings.py` - Perfiles de riesgo (extendido)
8. `app/service/paper_trading.py` - Nuevas tablas DB (extendido)
9. `main.py` - Nuevos endpoints API (extendido)

---

## üéä Pr√≥ximos Pasos

1. **Probar la UI Enhanced**:
   ```
   .\EJECUTAR_ENHANCED_UI.bat
   ```

2. **Ejecutar ejemplo de consola**:
   ```
   python examples/example_auto_strategy_selection.py
   ```

3. **Explorar los 3 tabs** en la UI:
   - Tab 1: Ver estrategia seleccionada autom√°ticamente
   - Tab 2: Comparar todas las estrategias
   - Tab 3: Ver historial (si tienes trades)

4. **Probar perfiles de riesgo**:
   - Cambiar capital en sidebar
   - Ver c√≥mo se selecciona el perfil autom√°ticamente

5. **Ejecutar tu primer trade**:
   - Seguir la gu√≠a de onboarding paso a paso
   - Usar capital peque√±o ($50-$100) para probar

---

## üí° Beneficios del Sistema

### Antes (Manual):
- ‚ùå Ten√≠as que decidir qu√© estrategia usar
- ‚ùå No sab√≠as cu√°l funcionaba mejor √∫ltimamente
- ‚ùå Ten√≠as que calcular manualmente los niveles
- ‚ùå No hab√≠a comparaci√≥n sistem√°tica

### Ahora (Autom√°tico):
- ‚úÖ El sistema elige la mejor estrategia por ti
- ‚úÖ Basado en datos de los √∫ltimos 90 d√≠as
- ‚úÖ Plan de trade completo generado autom√°ticamente
- ‚úÖ Confianza medida objetivamente
- ‚úÖ Historial y comparaci√≥n siempre disponibles

---

## üìà M√©tricas de Ranking

### Composite Score (0-100):
- **30%** - Sharpe Ratio (rendimiento ajustado por riesgo)
- **25%** - Win Rate (% de trades ganadores)
- **20%** - Max Drawdown (control de p√©rdidas)
- **15%** - Profit Factor (wins/losses ratio)
- **10%** - Expectancy (ganancia esperada por trade)

### Niveles de Confianza:
- **üü¢ HIGH** (75-100): Ejecutar con confianza
- **üü° MEDIUM** (50-74): Ejecutar con precauci√≥n
- **üî¥ LOW** (<50): Considerar skip o reducir tama√±o

---

## üêõ Troubleshooting

### "No se pudo generar recomendaci√≥n"
**Causa**: Faltan datos hist√≥ricos  
**Soluci√≥n**:
```powershell
python examples/example_fetch_data.py
```

### "Insufficient data for backtest"
**Causa**: Menos de 100 barras disponibles  
**Soluci√≥n**: Fetch m√°s datos o usar timeframe m√°s largo (1d)

### "No hay trades en historial"
**Causa**: No has ejecutado trades a√∫n  
**Soluci√≥n**: Es normal, ejecuta tu primer trade y aparecer√°

### Backtest muy lento (>30 seg)
**Causa**: Muchos datos o PC lenta  
**Soluci√≥n**: Reducir lookback_days de 90 a 30

---

## üéì Gu√≠a R√°pida para Principiantes

### Tu Primer Trade con Auto-Selection:

1. **Capital**: Empieza con $500-$1,000
2. **Perfil**: Selecciona "üå± Starter $1K"
3. **S√≠mbolo**: Usa BTC-USDT (m√°s l√≠quido)
4. **Timeframe**: Usa 1h o 4h (m√°s estable)
5. **Ejecuta ejemplo**: `python examples/example_auto_strategy_selection.py`
6. **Revisa recomendaci√≥n**: ¬øConfianza HIGH?
7. **Abre Binance**: Sigue la gu√≠a paso a paso
8. **Ejecuta**: Orden LIMIT + SL + TP
9. **Monitorea**: Durante el d√≠a
10. **Cierra**: Cuando se active SL o TP
11. **Registra**: Anota el resultado

### Despu√©s de 10 Trades:
- Revisa Win Rate en "Trade History"
- Compara con el backtest
- Ajusta risk% si es necesario
- Considera cambiar de perfil si el capital creci√≥

---

## üìû Soporte y Recursos

- **Documentaci√≥n**: Ver `UI_GUIDE.md` v2.0
- **Arquitectura**: Ver `ARCHITECTURE.md`
- **Backtesting**: Ver `BACKTEST_DESIGN.md`
- **API Docs**: http://localhost:8000/docs (cuando la API est√© corriendo)

---

**Versi√≥n**: 2.0.0  
**√öltima actualizaci√≥n**: Octubre 19, 2025  
**Estado**: ‚úÖ Completamente funcional y listo para usar

---

## üéâ ¬°Felicitaciones!

Ahora tienes un sistema de trading **completamente automatizado** que:
- Selecciona la mejor estrategia por ti
- Genera planes de trade concretos
- Monitorea la performance
- Alerta sobre divergencias

**¬°Empieza a tradear con confianza!** üöÄ

